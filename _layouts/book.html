<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>{{ page.title }} · {{ site.title }}</title>
    <style>
      :root{--gilded-deep:#7b5900;--gilded-soft:#fdf3d7;--gilded-shadow:rgba(71,48,2,.45)}
      body{font-family:system-ui,-apple-system,Segoe UI,Roboto,max-width:780px;margin:28px auto;padding:0 16px;background:#fdf8ee;color:#3b2e14}
      header{margin:12px 0 18px 0}
      header h1{margin-bottom:6px;color:var(--gilded-deep);letter-spacing:.02em}
      header::after{content:"";display:block;width:92px;height:4px;background:linear-gradient(90deg,rgba(183,138,40,.8),rgba(183,138,40,.2));border-radius:999px;margin-top:14px}
      .meta{display:grid;grid-template-columns:1fr;gap:16px}
      @media (min-width:820px){.meta{grid-template-columns:1fr 1fr}}
      .card{border:1px solid rgba(183,138,40,.3);border-radius:12px;padding:16px;margin:16px 0;background:rgba(255,252,245,.92);box-shadow:0 12px 28px -18px var(--gilded-shadow),0 0 0 1px rgba(183,138,40,.08)}
      .tag{font-size:.8rem;border:1px solid rgba(183,138,40,.4);border-radius:999px;padding:2px 8px;color:var(--gilded-deep);background:rgba(232,215,177,.45)}
      a{color:inherit}
      .form-row{display:flex;flex-direction:column;margin-bottom:14px}
      label{font-weight:600;margin-bottom:6px;color:#5c4306}
      input{padding:10px;border:1px solid rgba(183,138,40,.45);border-radius:10px;font:inherit;background:#fffaf0}
      button{padding:10px 16px;border-radius:10px;border:1px solid var(--gilded-deep);background:var(--gilded-deep);color:#fff3d6;font-weight:600;cursor:pointer;transition:transform .2s ease,box-shadow .2s ease}
      button:hover{background:#644700;border-color:#644700;transform:translateY(-1px);box-shadow:0 6px 18px -10px rgba(71,48,2,.55)}
      .status{font-size:.85rem;margin-top:4px}
      .seal{display:flex;align-items:center;justify-content:center;padding:24px;background:var(--gilded-soft);border:1px solid rgba(183,138,40,.6);box-shadow:0 0 0 3px rgba(183,138,40,.08) inset}
      .seal img{max-width:260px;width:100%;height:auto;filter:drop-shadow(0 6px 12px rgba(107,74,0,.2))}
    </style>
  </head>
  <body>
    <header>
      <div><a href="/">&larr; Inicio</a> · <a href="/collections/">Colecciones</a> ·
        <a href="/collections/{{ page.collection }}/">Colección</a></div>
      <h1>{{ page.title }}</h1>
      <div class="tag">{{ page.status | default: "Disponible" }}</div>
    </header>

    <div class="meta">
      <div class="card">
        <div><strong>Autor:</strong> {{ page.author }}</div>
        <div><strong>ISBN-13:</strong> {{ page.isbn13 }}</div>
        <div><strong>Serie:</strong> {{ page.series }}</div>
        <div><strong>Ubicación:</strong> <span data-location-display data-fallback="{{ page.location | default: 'Sin ubicación' }}">{{ page.location | default: "Sin ubicación" }}</span></div>
        <div><strong>Categoría:</strong> {{ page.category }}</div>
        <div><strong>Idioma:</strong> {{ page.language | default: "es" }}</div>
        <div><strong>Custodia:</strong> <span data-holder-display data-fallback="{{ page.holder | default: 'Sin registro' }}">{{ page.holder | default: "Sin registro" }}</span></div>
      </div>
      <div class="card">
        <strong>Relación con la colección</strong>
        <div>{{ page.collection_role | markdownify }}</div>
      </div>
      <div class="card">
        <strong>Seguimiento descentralizado</strong>
        <p>Al abrir esta página te pediremos tu ubicación actual para actualizar el registro. También puedes editar manualmente los datos; los cambios se guardan en este dispositivo para consultas rápidas.</p>
        <div class="form-row">
          <label for="location-input">Ubicación actual</label>
          <input id="location-input" type="text" inputmode="text" autocomplete="off" data-location-input placeholder="Ej. E1·A·2">
        </div>
        <div class="form-row">
          <label for="holder-input">Persona responsable</label>
          <input id="holder-input" type="text" inputmode="text" autocomplete="off" data-holder-input placeholder="Ej. Ana (Comunidad)">
        </div>
        <div class="form-row">
          <button type="button" data-reset-state>Restablecer valores del catálogo</button>
        </div>
        <p class="status" data-update-status hidden></p>
      </div>
      <div class="card seal">
        <img src="/assets/images/exlibris.png" alt="Sello Ex Libris de la Biblioteca Ecolístico" loading="lazy">
      </div>
    </div>

    <div class="card">
      <strong>Descripción</strong>
      <div>{{ content }}</div>
    </div>

    <p style="font-size:.9rem;opacity:.7">
      Colección: <code>{{ page.collection }}</code> ·
      ID Ecolístico: <code>{{ page.id }}</code> ·
      URL NFC: <code>{{ site.url }}{{ page.url }}</code>
    </p>
    <script type="application/json" id="book-defaults">
      {
        "key": {{ page.collection | append: "-" | append: page.id | jsonify }},
        "location": {{ page.location | jsonify }},
        "holder": {{ page.holder | jsonify }}
      }
    </script>
    <script>
      (function() {
        const defaultsElement = document.getElementById('book-defaults');
        if (!defaultsElement) return;

        let defaults;
        try {
          defaults = JSON.parse(defaultsElement.textContent || '{}');
        } catch (error) {
          console.error('No se pudieron leer los valores por defecto del libro.', error);
          return;
        }

        defaults.location = defaults.location || '';
        defaults.holder = defaults.holder || '';
        const storageKey = `ecolistico::book::${defaults.key || 'sin-clave'}`;

        let state = { ...defaults };
        try {
          const storedState = localStorage.getItem(storageKey);
          if (storedState) {
            const parsed = JSON.parse(storedState);
            state = { ...defaults, ...parsed };
          }
        } catch (error) {
          console.warn('No se pudieron cargar los datos locales de la biblioteca.', error);
        }

        const locationDisplay = document.querySelector('[data-location-display]');
        const holderDisplay = document.querySelector('[data-holder-display]');
        const locationInput = document.querySelector('[data-location-input]');
        const holderInput = document.querySelector('[data-holder-input]');
        const resetButton = document.querySelector('[data-reset-state]');
        const status = document.querySelector('[data-update-status]');

        if (!locationDisplay) {
          return;
        }

        const fallbackLocation = locationDisplay.dataset.fallback || defaults.location || 'Sin ubicación';
        const fallbackHolder = (holderDisplay && holderDisplay.dataset.fallback) || defaults.holder || 'Sin registro';
        let statusTimeout;

        function render(options = {}) {
          const { skipLocationInput = false, skipHolderInput = false } = options;
          locationDisplay.textContent = state.location || fallbackLocation;
          if (holderDisplay) {
            holderDisplay.textContent = state.holder || fallbackHolder;
          }
          if (!skipLocationInput && locationInput) {
            locationInput.value = state.location || '';
          }
          if (!skipHolderInput && holderInput) {
            holderInput.value = state.holder || '';
          }
        }

        function showStatus(message, isError) {
          if (!status) return;
          status.textContent = message;
          status.hidden = false;
          status.style.color = isError ? '#b42318' : '#0b6e4f';
          if (statusTimeout) clearTimeout(statusTimeout);
          statusTimeout = setTimeout(() => {
            status.hidden = true;
          }, 3200);
        }

        function persist() {
          try {
            localStorage.setItem(storageKey, JSON.stringify(state));
            showStatus('Cambios guardados en este dispositivo.');
          } catch (error) {
            showStatus('No se pudo guardar la información localmente.', true);
          }
        }

        function updateState(key, value, renderOptions) {
          state = { ...state, [key]: value.trim() };
          render(renderOptions);
          persist();
        }

        function requestCurrentLocation() {
          if (!('geolocation' in navigator)) {
            showStatus('Este dispositivo no admite geolocalización automática.', true);
            return;
          }

          showStatus('Solicitando tu ubicación actual…');
          navigator.geolocation.getCurrentPosition(
            (position) => {
              const { latitude, longitude } = position.coords;
              const formatted = `Lat ${latitude.toFixed(5)}, Lon ${longitude.toFixed(5)}`;
              updateState('location', formatted);
              showStatus('Ubicación actualizada con tu posición.');
            },
            (error) => {
              let message = 'No se pudo obtener tu ubicación.';
              if (error.code === error.PERMISSION_DENIED) {
                message = 'No se obtuvo permiso para acceder a tu ubicación.';
              }
              showStatus(message, true);
            },
            {
              enableHighAccuracy: false,
              maximumAge: 300000,
              timeout: 10000
            }
          );
        }

        if (locationInput) {
          locationInput.addEventListener('input', (event) => {
            updateState('location', event.target.value, { skipLocationInput: true });
          });
        }

        if (holderInput) {
          holderInput.addEventListener('input', (event) => {
            updateState('holder', event.target.value, { skipHolderInput: true });
          });
        }

        if (resetButton) {
          resetButton.addEventListener('click', () => {
            state = { ...defaults };
            render();
            persist();
          });
        }

        render();
        requestCurrentLocation();
      })();
    </script>
  </body>
</html>
